<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>„Çπ„Ç´„ÉÉ„Ç∑„É•„Éà„Éº„Éä„É°„É≥„ÉàË°®‰ΩúÊàê„ÉÑ„Éº„É´</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .input-field label {
            font-weight: bold;
            color: #2a5298;
        }

        .input-field input, .input-field select {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-field input:focus, .input-field select:focus {
            border-color: #2a5298;
            outline: none;
        }

        .players-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-bottom: 30px;
        }

        .players-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-input {
            display: grid;
            grid-template-columns: 30px 2fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f8f9fa;
        }

        .player-input input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .player-input select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(42, 82, 152, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .tournament-display {
            background: rgba(255, 255, 255, 0.98);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            overflow-x: auto;
        }

        .tournament-bracket {
            min-width: 1000px;
            display: flex;
            gap: 40px;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
        }

        .round {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
        }

        .round h3 {
            color: #2a5298;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2em;
            position: sticky;
            top: 0;
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .match {
            background: white;
            border: 2px solid #2a5298;
            border-radius: 12px;
            padding: 15px;
            min-width: 220px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            position: relative;
        }

        .match:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(42, 82, 152, 0.2);
        }

        .match.completed {
            border-color: #28a745;
            background: linear-gradient(135deg, #f8fff9 0%, #e6ffe6 100%);
        }

        .match.in-progress {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fffbf0 0%, #fff3cd 100%);
        }

        .court-info {
            position: absolute;
            top: -8px;
            right: 10px;
            background: #2a5298;
            color: white;
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: bold;
        }

        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .match-id {
            font-size: 12px;
            color: #666;
            font-weight: bold;
        }

        .player-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 3px 0;
            background: #f8f9fa;
            transition: background-color 0.3s;
        }

        .player-row.winner {
            background: #d4edda;
            border-color: #28a745;
            font-weight: bold;
        }

        .player-row.loser {
            background: #f8d7da;
            border-color: #dc3545;
            opacity: 0.7;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }

        .seed {
            background: #2a5298;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .affiliation {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
        }

        .score-input {
            width: 40px;
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }

        .score-display {
            font-weight: bold;
            color: #2a5298;
            margin-left: 8px;
        }

        .bye {
            background: #e9ecef;
            color: #6c757d;
            font-style: italic;
        }

        .connector {
            width: 30px;
            height: 2px;
            background: #2a5298;
            position: relative;
            align-self: center;
        }

        .tournament-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(42, 82, 152, 0.1);
            border-radius: 10px;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            border: 1px solid #c3e6cb;
        }

        .settings-panel {
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 10px 0;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .court-assignment {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .court-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }

        .court-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .court-item select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #2a5298;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .players-grid {
                grid-template-columns: 1fr;
            }
            
            .tournament-bracket {
                flex-direction: column;
                gap: 30px;
                align-items: center;
            }
            
            .player-input {
                grid-template-columns: 25px 1fr 80px 80px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè∏ „Çπ„Ç´„ÉÉ„Ç∑„É•„Éà„Éº„Éä„É°„É≥„ÉàË°®‰ΩúÊàê„ÉÑ„Éº„É´</h1>
            <p>„Éó„É≠„Éï„Çß„ÉÉ„Ç∑„Éß„Éä„É´„Å™„Éà„Éº„Éä„É°„É≥„ÉàË°®„ÇíÁ∞°Âçò‰ΩúÊàê</p>
        </div>

        <div class="control-panel">
            <div class="input-group">
                <div class="input-field">
                    <label>Â§ß‰ºöÂêç</label>
                    <input type="text" id="tournamentName" placeholder="Â§ß‰ºöÂêç„ÇíÂÖ•Âäõ" value="„Çπ„Ç´„ÉÉ„Ç∑„É•Â§ß‰ºö">
                </div>
                <div class="input-field">
                    <label>ÈñãÂÇ¨Êó•</label>
                    <input type="date" id="tournamentDate">
                </div>
                <div class="input-field">
                    <label>‰ºöÂ†¥</label>
                    <input type="text" id="venue" placeholder="‰ºöÂ†¥Âêç„ÇíÂÖ•Âäõ">
                </div>
                <div class="input-field">
                    <label>ÂèÇÂä†ËÄÖÊï∞</label>
                    <select id="playerCount" onchange="updatePlayerInputs()">
                        <option value="4">4‰∫∫</option>
                        <option value="8" selected>8‰∫∫</option>
                        <option value="16">16‰∫∫</option>
                        <option value="32">32‰∫∫</option>
                    </select>
                </div>
            </div>

            <div class="settings-panel">
                <h3>„Éà„Éº„Éä„É°„É≥„ÉàË®≠ÂÆö</h3>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="seedCorners" checked>
                        „Ç∑„Éº„Éâ„Çí4ÈöÖ„Å´ÈÖçÁΩÆ
                    </label>
                    <label>
                        <input type="checkbox" id="strengthBalance" checked>
                        Âº∑„ÅÑ‰∫∫„Å®Âº±„ÅÑ‰∫∫„ÅåÂΩì„Åü„Çã„Çà„ÅÜ„Å´Ë™øÊï¥
                    </label>
                    <label>
                        <input type="checkbox" id="avoidSameAffiliation" checked>
                        Âêå„ÅòÊâÄÂ±û„ÅÆÂØæÊà¶„ÇíÂõûÈÅø
                    </label>
                    <label>
                        <input type="checkbox" id="randomizeNonSeeded" checked>
                        „Éé„Éº„Ç∑„Éº„ÉâÈÅ∏Êâã„Çí„É©„É≥„ÉÄ„É†ÈÖçÁΩÆ
                    </label>
                </div>
            </div>

            <div class="input-group">
                <button class="btn" onclick="generateTournament()">„Éà„Éº„Éä„É°„É≥„ÉàË°®‰ΩúÊàê</button>
                <button class="btn btn-secondary" onclick="exportTournament()">PDFÂá∫Âäõ</button>
                <button class="btn btn-secondary" onclick="resetTournament()">„É™„Çª„ÉÉ„Éà</button>
            </div>
        </div>

        <div class="players-container">
            <h3>ÂèÇÂä†ËÄÖÊÉÖÂ†±ÂÖ•Âäõ</h3>
            <div class="input-group" style="margin-bottom: 15px;">
                <small>È†ÜÁï™: ÈÅ∏ÊâãÂêç | „Ç∑„Éº„ÉâÁï™Âè∑ | ÊâÄÂ±û</small>
            </div>
            <div id="playersGrid" class="players-grid"></div>
        </div>

        <div id="courtAssignment" class="court-assignment" style="display: none;">
            <h3>„Ç≥„Éº„ÉàÂâ≤„ÇäÂΩì„Å¶</h3>
            <div id="courtGrid" class="court-grid"></div>
            <button class="btn btn-small" onclick="assignCourts()">„Ç≥„Éº„ÉàÂâ≤„ÇäÂΩì„Å¶ÂÆüË°å</button>
        </div>

        <div id="tournamentDisplay" class="tournament-display" style="display: none;">
            <div class="tournament-info">
                <h2 id="displayTournamentName"></h2>
                <p id="displayTournamentDetails"></p>
            </div>
            <div id="tournamentBracket" class="tournament-bracket"></div>
        </div>

        <div id="errorMessage" class="error-message" style="display: none;"></div>
        <div id="successMessage" class="success-message" style="display: none;"></div>
    </div>

    <!-- „Çπ„Ç≥„Ç¢ÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ -->
    <div id="scoreModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeScoreModal()">&times;</span>
            <h3>Ë©¶ÂêàÁµêÊûúÂÖ•Âäõ</h3>
            <div id="scoreForm"></div>
            <br>
            <button class="btn" onclick="submitScore()">ÁµêÊûú„Çí‰øùÂ≠ò</button>
        </div>
    </div>

    <script>
        let players = [];
        let tournament = null;
        let bracket = [];
        let courts = ['„Ç≥„Éº„Éà1', '„Ç≥„Éº„Éà2', '„Ç≥„Éº„Éà3', '„Ç≥„Éº„Éà4'];
        let currentScoreMatch = null;

        // ÂàùÊúüÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tournamentDate').value = today;
            updatePlayerInputs();
        });

        function updatePlayerInputs() {
            const count = parseInt(document.getElementById('playerCount').value);
            const grid = document.getElementById('playersGrid');
            grid.innerHTML = '';

            for (let i = 1; i <= count; i++) {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-input';
                playerDiv.innerHTML = `
                    <span>${i}.</span>
                    <input type="text" id="player${i}" placeholder="ÈÅ∏ÊâãÂêç" onchange="updatePlayer(${i})">
                    <input type="number" id="seed${i}" placeholder="„Ç∑„Éº„Éâ" min="0" max="${count}" onchange="updatePlayer(${i})">
                    <input type="text" id="affiliation${i}" placeholder="ÊâÄÂ±û" onchange="updatePlayer(${i})">
                `;
                grid.appendChild(playerDiv);
            }

            players = Array.from({length: count}, (_, i) => ({
                id: i + 1,
                name: '',
                seed: 0,
                affiliation: '',
                position: i + 1
            }));
        }

        function updatePlayer(index) {
            const name = document.getElementById(`player${index}`).value;
            const seed = parseInt(document.getElementById(`seed${index}`).value) || 0;
            const affiliation = document.getElementById(`affiliation${index}`).value;
            
            if (players[index - 1]) {
                players[index - 1].name = name;
                players[index - 1].seed = seed;
                players[index - 1].affiliation = affiliation;
            }
        }

        class TournamentGenerator {
            constructor(players, options = {}) {
                this.players = players.filter(p => p.name.trim() !== '');
                this.options = {
                    seedCorners: true,
                    strengthBalance: true,
                    avoidSameAffiliation: true,
                    randomizeNonSeeded: true,
                    ...options
                };
                this.drawSize = this.calculateDrawSize();
                this.bracket = [];
            }

            calculateDrawSize() {
                const playerCount = this.players.length;
                return Math.pow(2, Math.ceil(Math.log2(playerCount)));
            }

            generateSeededTournament() {
                const seededPlayers = this.players.filter(p => p.seed > 0)
                    .sort((a, b) => a.seed - b.seed);
                const nonSeededPlayers = this.players.filter(p => p.seed === 0);

                if (this.options.randomizeNonSeeded) {
                    this.shuffleArray(nonSeededPlayers);
                }

                // Âêå„ÅòÊâÄÂ±û„ÅÆÂõûÈÅøÂá¶ÁêÜ
                if (this.options.avoidSameAffiliation) {
                    nonSeededPlayers.sort(this.affiliationSortFunction);
                }

                const positions = this.calculateSeedPositions(seededPlayers);
                const draw = new Array(this.drawSize).fill(null);

                // „Ç∑„Éº„ÉâÈÅ∏Êâã„ÇíÈÖçÁΩÆ
                seededPlayers.forEach((player, index) => {
                    if (positions[index] !== undefined) {
                        draw[positions[index] - 1] = {
                            ...player,
                            displaySeed: player.seed
                        };
                    }
                });

                // „Éé„Éº„Ç∑„Éº„ÉâÈÅ∏Êâã„ÇíÈÖçÁΩÆÔºàÂêå„ÅòÊâÄÂ±ûÂõûÈÅø„ÇíËÄÉÊÖÆÔºâ
                this.placeNonSeededPlayers(draw, nonSeededPlayers);

                // BYE„ÇíËøΩÂä†
                for (let i = 0; i < this.drawSize; i++) {
                    if (draw[i] === null) {
                        draw[i] = {
                            id: `bye${i}`,
                            name: 'BYE',
                            seed: 0,
                            displaySeed: 0,
                            affiliation: '',
                            isBye: true
                        };
                    }
                }

                return draw;
            }

            affiliationSortFunction(a, b) {
                // ÊâÄÂ±û„Åß„Ç∞„É´„Éº„ÉóÂåñ„Åó„ÄÅÂêå„ÅòÊâÄÂ±û„ÅØÈõ¢„Çå„Çã„Çà„ÅÜ„Å´ÈÖçÁΩÆ
                if (a.affiliation === b.affiliation) return 0;
                if (a.affiliation < b.affiliation) return -1;
                return 1;
            }

            placeNonSeededPlayers(draw, nonSeededPlayers) {
                const availablePositions = [];
                for (let i = 0; i < draw.length; i++) {
                    if (draw[i] === null) {
                        availablePositions.push(i);
                    }
                }

                for (const player of nonSeededPlayers) {
                    let bestPosition = -1;
                    let maxSeparation = -1;

                    for (const position of availablePositions) {
                        if (draw[position] !== null) continue;

                        let separation = this.calculateAffiliationSeparation(draw, position, player.affiliation);
                        if (separation > maxSeparation) {
                            maxSeparation = separation;
                            bestPosition = position;
                        }
                    }

                    if (bestPosition !== -1) {
                        draw[bestPosition] = {
                            ...player,
                            displaySeed: 0
                        };
                        availablePositions.splice(availablePositions.indexOf(bestPosition), 1);
                    }
                }
            }

            calculateAffiliationSeparation(draw, position, affiliation) {
                if (!affiliation) return 1000; // ÊâÄÂ±û„Å™„Åó„ÅØÂïèÈ°å„Å™„Åó

                let minDistance = 1000;
                for (let i = 0; i < draw.length; i++) {
                    if (draw[i] && draw[i].affiliation === affiliation && i !== position) {
                        const distance = Math.abs(i - position);
                        minDistance = Math.min(minDistance, distance);
                    }
                }
                return minDistance;
            }

            calculateSeedPositions(seededPlayers) {
                const positions = [];
                const drawSize = this.drawSize;

                if (seededPlayers.length >= 1) positions.push(1);
                if (seededPlayers.length >= 2) positions.push(drawSize);
                if (seededPlayers.length >= 3) positions.push(drawSize / 2 + 1);
                if (seededPlayers.length >= 4) positions.push(drawSize / 2);

                // 5-8„Ç∑„Éº„Éâ
                if (seededPlayers.length >= 5) {
                    positions.push(drawSize / 4 + 1);
                    positions.push(drawSize * 3 / 4);
                    positions.push(drawSize / 4 * 3 + 1);
                    positions.push(drawSize / 4);
                }

                // ÊÆã„Çä„ÅÆ„Ç∑„Éº„Éâ„Éù„Ç∏„Ç∑„Éß„É≥
                for (let i = 9; i <= seededPlayers.length; i++) {
                    const availablePositions = [];
                    for (let j = 1; j <= drawSize; j++) {
                        if (!positions.includes(j)) {
                            availablePositions.push(j);
                        }
                    }
                    if (availablePositions.length > 0) {
                        const randomIndex = Math.floor(Math.random() * availablePositions.length);
                        positions.push(availablePositions[randomIndex]);
                    }
                }

                return positions;
            }

            shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            generateBracket() {
                const draw = this.generateSeededTournament();
                const rounds = Math.log2(this.drawSize);
                const bracket = [];

                // 1ÂõûÊà¶
                const firstRound = [];
                for (let i = 0; i < draw.length; i += 2) {
                    firstRound.push({
                        id: `match_1_${i/2 + 1}`,
                        round: 1,
                        matchNumber: i/2 + 1,
                        players: [draw[i], draw[i + 1]],
                        scores: [0, 0],
                        winner: null,
                        completed: false,
                        court: null
                    });
                }
                bracket.push(firstRound);

                // ÂæåÁ∂ö„É©„Ç¶„É≥„Éâ
                for (let round = 2; round <= rounds; round++) {
                    const roundMatches = [];
                    const prevRound = bracket[round - 2];
                    
                    for (let i = 0; i < prevRound.length; i += 2) {
                        roundMatches.push({
                            id: `match_${round}_${i/2 + 1}`,
                            round: round,
                            matchNumber: i/2 + 1,
                            players: [null, null],
                            scores: [0, 0],
                            winner: null,
                            completed: false,
                            court: null,
                            prevMatches: [prevRound[i], prevRound[i + 1]]
                        });
                    }
                    bracket.push(roundMatches);
                }

                return bracket;
            }
        }

        function generateTournament() {
            try {
                hideError();
                
                const filledPlayers = players.filter(p => p.name.trim() !== '');
                
                if (filledPlayers.length < 2) {
                    throw new Error('ÊúÄ‰Ωé2Âêç„ÅÆÂèÇÂä†ËÄÖ„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ');
                }

                const options = {
                    seedCorners: document.getElementById('seedCorners').checked,
                    strengthBalance: document.getElementById('strengthBalance').checked,
                    avoidSameAffiliation: document.getElementById('avoidSameAffiliation').checked,
                    randomizeNonSeeded: document.getElementById('randomizeNonSeeded').checked
                };

                const generator = new TournamentGenerator(filledPlayers, options);
                bracket = generator.generateBracket();
                
                displayTournament(bracket, generator.drawSize);
                showCourtAssignment();
                showSuccess('„Éà„Éº„Éä„É°„É≥„ÉàË°®„ÅåÊ≠£Â∏∏„Å´‰ΩúÊàê„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                
            } catch (error) {
                showError(error.message);
            }
        }

        function displayTournament(bracket, drawSize) {
            const display = document.getElementById('tournamentDisplay');
            const bracketDiv = document.getElementById('tournamentBracket');
            
            document.getElementById('displayTournamentName').textContent = 
                document.getElementById('tournamentName').value || '„Çπ„Ç´„ÉÉ„Ç∑„É•Â§ß‰ºö';
            
            const date = document.getElementById('tournamentDate').value;
            const venue = document.getElementById('venue').value;
            document.getElementById('displayTournamentDetails').textContent = 
                `${date ? 'ÈñãÂÇ¨Êó•: ' + date : ''} ${venue ? '‰ºöÂ†¥: ' + venue : ''} (${drawSize}„Éâ„É≠„Éº)`;

            bracketDiv.innerHTML = '';

            bracket.forEach((round, roundIndex) => {
                const roundDiv = document.createElement('div');
                roundDiv.className = 'round';
                
                const roundTitle = document.createElement('h3');
                const roundNames = ['1ÂõûÊà¶', '2ÂõûÊà¶', 'Ê∫ñ„ÄÖÊ±∫Âãù', 'Ê∫ñÊ±∫Âãù', 'Ê±∫Âãù'];
                roundTitle.textContent = roundNames[roundIndex] || `${roundIndex + 1}ÂõûÊà¶`;
                roundDiv.appendChild(roundTitle);

                round.forEach(match => {
                    const matchDiv = document.createElement('div');
                    matchDiv.className = `match ${match.completed ? 'completed' : ''}`;
                    
                    if (match.court) {
                        const courtInfo = document.createElement('div');
                        courtInfo.className = 'court-info';
                        courtInfo.textContent = match.court;
                        matchDiv.appendChild(courtInfo);
                    }

                    const matchHeader = document.createElement('div');
                    matchHeader.className = 'match-header';
                    matchHeader.innerHTML = `
                        <span class="match-id">R${match.round}-M${match.matchNumber}</span>
                        ${!match.completed && match.players[0] && match.players[1] && !match.players[0].isBye && !match.players[1].isBye ? 
                            `<button class="btn btn-small" onclick="openScoreModal('${match.id}')">„Çπ„Ç≥„Ç¢ÂÖ•Âäõ</button>` : ''}
                    `;
                    matchDiv.appendChild(matchHeader);
                    
                    match.players.forEach((player, playerIndex) => {
                        const playerRow = document.createElement('div');
                        let className = 'player-row';
                        
                        if (match.completed && match.winner === playerIndex) {
                            className += ' winner';
                        } else if (match.completed && match.winner !== playerIndex && match.winner !== null) {
                            className += ' loser';
                        }
                        
                        playerRow.className = className;
                        
                        if (player) {
                            if (player.isBye) {
                                playerRow.classList.add('bye');
                                playerRow.innerHTML = '<span>BYE</span>';
                            } else {
                                const playerInfo = document.createElement('div');
                                playerInfo.className = 'player-info';
                                
                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = player.name;
                                playerInfo.appendChild(nameSpan);
                                
                                if (player.displaySeed > 0) {
                                    const seedSpan = document.createElement('span');
                                    seedSpan.className = 'seed';
                                    seedSpan.textContent = `[${player.displaySeed}]`;
                                    playerInfo.appendChild(seedSpan);
                                }
                                
                                if (player.affiliation) {
                                    const affiliationSpan = document.createElement('span');
                                    affiliationSpan.className = 'affiliation';
                                    affiliationSpan.textContent = player.affiliation;
                                    playerInfo.appendChild(affiliationSpan);
                                }
                                
                                playerRow.appendChild(playerInfo);
                                
                                if (match.completed) {
                                    const scoreSpan = document.createElement('span');
                                    scoreSpan.className = 'score-display';
                                    scoreSpan.textContent = match.scores[playerIndex];
                                    playerRow.appendChild(scoreSpan);
                                }
                            }
                        } else {
                            playerRow.innerHTML = '<span>Ôºç</span>';
                        }
                        
                        matchDiv.appendChild(playerRow);
                    });
                    
                    roundDiv.appendChild(matchDiv);
                });

                bracketDiv.appendChild(roundDiv);

                // „Ç≥„Éç„ÇØ„Çø„Éº„ÇíËøΩÂä†ÔºàÊúÄÂæå„ÅÆ„É©„Ç¶„É≥„Éâ‰ª•Â§ñÔºâ
                if (roundIndex < bracket.length - 1) {
                    const connector = document.createElement('div');
                    connector.className = 'connector';
                    bracketDiv.appendChild(connector);
                }
            });

            display.style.display = 'block';
        }

        function showCourtAssignment() {
            const courtAssignment = document.getElementById('courtAssignment');
            const courtGrid = document.getElementById('courtGrid');
            courtGrid.innerHTML = '';

            // 1ÂõûÊà¶„ÅÆË©¶Âêà„ÅÆ„Åø„Ç≥„Éº„ÉàÂâ≤„ÇäÂΩì„Å¶
            const firstRound = bracket[0];
            
            firstRound.forEach(match => {
                if (match.players[0] && match.players[1] && !match.players[0].isBye && !match.players[1].isBye) {
                    const courtItem = document.createElement('div');
                    courtItem.className = 'court-item';
                    
                    const matchInfo = `R${match.round}-M${match.matchNumber}: ${match.players[0].name} vs ${match.players[1].name}`;
                    
                    courtItem.innerHTML = `
                        <strong>${matchInfo}</strong>
                        <select id="court_${match.id}">
                            <option value="">„Ç≥„Éº„Éà„ÇíÈÅ∏Êäû</option>
                            ${courts.map(court => `<option value="${court}">${court}</option>`).join('')}
                        </select>
                    `;
                    
                    courtGrid.appendChild(courtItem);
                }
            });

            courtAssignment.style.display = 'block';
        }

        function assignCourts() {
            const firstRound = bracket[0];
            
            firstRound.forEach(match => {
                const courtSelect = document.getElementById(`court_${match.id}`);
                if (courtSelect && courtSelect.value) {
                    match.court = courtSelect.value;
                }
            });

            displayTournament(bracket, Math.pow(2, Math.ceil(Math.log2(players.filter(p => p.name.trim() !== '').length))));
            showSuccess('„Ç≥„Éº„ÉàÂâ≤„ÇäÂΩì„Å¶„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„ÅüÔºÅ');
        }

        function openScoreModal(matchId) {
            const match = findMatchById(matchId);
            if (!match || match.completed) return;

            currentScoreMatch = match;
            const modal = document.getElementById('scoreModal');
            const form = document.getElementById('scoreForm');
            
            form.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <strong>${match.players[0].name} vs ${match.players[1].name}</strong>
                    ${match.court ? `<br><small>„Ç≥„Éº„Éà: ${match.court}</small>` : ''}
                </div>
                <div style="display: flex; gap: 20px; align-items: center; justify-content: center;">
                    <div style="text-align: center;">
                        <div><strong>${match.players[0].name}</strong></div>
                        <input type="number" id="score0" min="0" max="20" value="${match.scores[0]}" style="width: 60px; text-align: center; font-size: 18px; padding: 8px; margin-top: 8px;">
                    </div>
                    <div style="font-size: 24px; font-weight: bold;">-</div>
                    <div style="text-align: center;">
                        <div><strong>${match.players[1].name}</strong></div>
                        <input type="number" id="score1" min="0" max="20" value="${match.scores[1]}" style="width: 60px; text-align: center; font-size: 18px; padding: 8px; margin-top: 8px;">
                    </div>
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <small>ÂãùËÄÖ„ÅÆ„Çπ„Ç≥„Ç¢„ÇíÈ´ò„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        function closeScoreModal() {
            document.getElementById('scoreModal').style.display = 'none';
            currentScoreMatch = null;
        }

        function submitScore() {
            if (!currentScoreMatch) return;

            const score0 = parseInt(document.getElementById('score0').value) || 0;
            const score1 = parseInt(document.getElementById('score1').value) || 0;

            if (score0 === score1) {
                alert('Âºï„ÅçÂàÜ„Åë„ÅØË™ç„ÇÅ„Çâ„Çå„Åæ„Åõ„Çì„ÄÇÂãùËÄÖ„ÇíÊ±∫ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
                return;
            }

            currentScoreMatch.scores = [score0, score1];
            currentScoreMatch.winner = score0 > score1 ? 0 : 1;
            currentScoreMatch.completed = true;

            // ÂãùËÄÖ„ÇíÊ¨°„ÅÆ„É©„Ç¶„É≥„Éâ„Å´ÈÄ≤„ÇÅ„Çã
            advanceWinner(currentScoreMatch);
            
            // Ë°®Á§∫„ÇíÊõ¥Êñ∞
            displayTournament(bracket, Math.pow(2, Math.ceil(Math.log2(players.filter(p => p.name.trim() !== '').length))));
            
            closeScoreModal();
            showSuccess(`Ë©¶ÂêàÁµêÊûú„Åå‰øùÂ≠ò„Åï„Çå„Åæ„Åó„ÅüÔºÅÂãùËÄÖ: ${currentScoreMatch.players[currentScoreMatch.winner].name}`);
        }

        function advanceWinner(completedMatch) {
            const winner = completedMatch.players[completedMatch.winner];
            
            // Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„ÇíÊé¢„Åô
            for (let roundIndex = 1; roundIndex < bracket.length; roundIndex++) {
                const round = bracket[roundIndex];
                
                for (let match of round) {
                    if (match.prevMatches && match.prevMatches.includes(completedMatch)) {
                        // „Åì„ÅÆË©¶Âêà„Å´ÂãùËÄÖ„ÇíÈÄ≤„ÇÅ„Çã
                        if (match.players[0] === null) {
                            match.players[0] = winner;
                        } else if (match.players[1] === null) {
                            match.players[1] = winner;
                        }
                        return;
                    }
                }
            }
        }

        function findMatchById(matchId) {
            for (let round of bracket) {
                for (let match of round) {
                    if (match.id === matchId) {
                        return match;
                    }
                }
            }
            return null;
        }

        function resetTournament() {
            if (confirm('„Éà„Éº„Éä„É°„É≥„Éà„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü„Åô„Åπ„Å¶„ÅÆÁµêÊûú„ÅåÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ')) {
                bracket = [];
                document.getElementById('tournamentDisplay').style.display = 'none';
                document.getElementById('courtAssignment').style.display = 'none';
                hideError();
                hideSuccess();
                updatePlayerInputs();
                showSuccess('„Éà„Éº„Éä„É°„É≥„Éà„Åå„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü„ÄÇ');
            }
        }

        function exportTournament() {
            // Âç∞Âà∑Áî®„ÅÆ„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®„Åó„Å¶PDFÂá∫Âäõ
            const printWindow = window.open('', '', 'height=600,width=800');
            const tournamentHtml = document.getElementById('tournamentDisplay').innerHTML;
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>„Çπ„Ç´„ÉÉ„Ç∑„É•„Éà„Éº„Éä„É°„É≥„ÉàË°®</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .tournament-bracket { display: flex; gap: 30px; }
                        .round { display: flex; flex-direction: column; gap: 15px; }
                        .match { border: 2px solid #2a5298; border-radius: 8px; padding: 10px; margin: 5px 0; min-width: 180px; }
                        .player-row { border: 1px solid #ddd; padding: 5px; margin: 2px 0; border-radius: 4px; }
                        .winner { background: #d4edda; font-weight: bold; }
                        .seed { background: #2a5298; color: white; padding: 2px 6px; border-radius: 8px; font-size: 11px; }
                        .affiliation { background: #6c757d; color: white; padding: 2px 4px; border-radius: 6px; font-size: 10px; }
                        .court-info { background: #2a5298; color: white; padding: 2px 6px; border-radius: 6px; font-size: 11px; float: right; }
                        h2, h3 { color: #2a5298; }
                        @media print { body { margin: 10px; font-size: 12px; } }
                    </style>
                </head>
                <body>${tournamentHtml}</body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(hideError, 5000);
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(hideSuccess, 3000);
        }

        function hideSuccess() {
            document.getElementById('successMessage').style.display = 'none';
        }

        // „É¢„Éº„ÉÄ„É´„ÅÆÂ§ñÂÅ¥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâÈñâ„Åò„Çã
        window.onclick = function(event) {
            const modal = document.getElementById('scoreModal');
            if (event.target === modal) {
                closeScoreModal();
            }
        }
    </script>
</body>
</html>
